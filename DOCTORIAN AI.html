<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doctorian Medical AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Base styles */
      body {
        font-family: "Inter", sans-serif;
        scroll-behavior: smooth;
      }

      /* Theme transition */
      .theme-transition {
        transition: background-color 0.5s ease, color 0.5s ease,
          border-color 0.5s ease;
      }

      /* Scrollbar styles for a modern look */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1e293b; /* dark-slate-800 */
      }
      ::-webkit-scrollbar-thumb {
        background: #475569; /* dark-slate-600 */
        border-radius: 10px;
      }
      html.light ::-webkit-scrollbar-track {
        background: #e2e8f0; /* light-slate-200 */
      }
      html.light ::-webkit-scrollbar-thumb {
        background: #94a3b8; /* light-slate-400 */
      }

      /* Animation classes for scroll effects */
      .fade-in-up {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s cubic-bezier(0.645, 0.045, 0.355, 1),
          transform 0.6s cubic-bezier(0.645, 0.045, 0.355, 1);
      }
      .fade-in-up.is-visible {
        opacity: 1;
        transform: translateY(0);
      }

      /* Chat bubble styles */
      .chat-bubble-user {
        background-color: #3b82f6; /* blue-500 */
        color: white;
        border-radius: 20px 20px 5px 20px;
      }
      .chat-bubble-model {
        background-color: #334155; /* slate-700 */
        color: #f1f5f9; /* slate-100 */
        border-radius: 20px 20px 20px 5px;
      }
      html.light .chat-bubble-model {
        background-color: #e2e8f0; /* slate-200 */
        color: #1e293b; /* slate-800 */
      }

      /* Typing indicator animation */
      .typing-indicator span {
        height: 8px;
        width: 8px;
        float: left;
        margin: 0 1px;
        background-color: #9ca3af; /* gray-400 */
        display: block;
        border-radius: 50%;
        opacity: 0.4;
        animation: 1s blink infinite 0.3333s;
      }
      html.light .typing-indicator span {
        background-color: #6b7280; /* gray-500 */
      }
      .typing-indicator span:nth-child(2) {
        animation-delay: 0.6666s;
      }
      .typing-indicator span:nth-child(3) {
        animation-delay: 0.9999s;
      }
      @keyframes blink {
        50% {
          opacity: 1;
        }
      }

      /* Shimmer animation for loading states */
      .shimmer {
        position: relative;
        overflow: hidden;
        background-color: #334155; /* slate-700 */
      }
      html.light .shimmer {
        background-color: #e2e8f0; /* slate-200 */
      }
      .shimmer::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        animation: shimmer-animation 1.5s infinite;
      }
      html.light .shimmer::after {
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
      }
      @keyframes shimmer-animation {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      /* Styling for result cards from new features */
      .result-card {
        background-color: rgba(40, 52, 72, 0.5);
      }
      html.light .result-card {
        background-color: rgba(241, 245, 249, 0.7);
      }
    </style>
    <script>
      // Tailwind dark mode configuration
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    
    <!-- AI SDK Scripts -->
    <script src="https://lib.youware.com/youware-ai-4.3.16.js"></script>
    <script src="https://lib.youware.com/youware-openai-1.3.22.js"></script>
    <script src="https://lib.youware.com/youware-zod-3.25.67.js"></script>
  </head>
  <body class="bg-slate-900 text-slate-200 theme-transition">
    <!-- Header -->
    <header
      class="fixed top-0 left-0 right-0 bg-slate-900/80 dark:bg-slate-900/80 backdrop-blur-sm z-50 theme-transition border-b border-slate-700 dark:border-slate-800"
    >
      <nav
        class="container mx-auto px-6 py-4 flex justify-between items-center"
      >
        <a
          href="#"
          class="text-2xl font-bold text-white flex items-center gap-2"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="color: #fa5ff2"
          >
            <path
              d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"
            ></path>
            <path d="M3.22 12H9.5l.7-1 2.1 4.2 3-6 1 2h3.22"></path>
          </svg>
          Doctorian Medical AI
        </a>
        <div class="hidden md:flex items-center gap-6">
          <a
            href="#symptom-analyzer"
            class="text-slate-300 hover:text-white transition"
            >Symptom Analyzer</a
          >
          <a
            href="#nutrition-planner"
            class="text-slate-300 hover:text-white transition"
            >Nutrition Planner</a
          >
          <a
            href="#healthbuddy"
            class="text-slate-300 hover:text-white transition"
            >Ask HealthBuddy</a
          >
          <a
            href="#visualizer"
            class="text-slate-300 hover:text-white transition"
            >AI Visualizer</a
          >
        </div>
        <div class="flex items-center gap-4">
          <button
            id="theme-toggle"
            class="p-2 rounded-full hover:bg-slate-700 transition"
          >
            <svg
              id="theme-icon-dark"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="4"></circle>
              <path d="M12 2v2"></path>
              <path d="M12 20v2"></path>
              <path d="m4.93 4.93 1.41 1.41"></path>
              <path d="m17.66 17.66 1.41 1.41"></path>
              <path d="M2 12h2"></path>
              <path d="M20 12h2"></path>
              <path d="m6.34 17.66-1.41 1.41"></path>
              <path d="m19.07 4.93-1.41 1.41"></path>
            </svg>
          </button>
        </div>
      </nav>
    </header>

    <main class="pt-20">
      <!-- Hero Section -->
      <section class="container mx-auto px-6 py-20 md:py-32 text-center">
        <div class="animate-content fade-in-up">
          <h1
            class="text-4xl md:text-6xl font-extrabold text-white leading-tight"
          >
            Your Personal AI <br class="hidden md:block" />
            <span
              class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-400"
              >Health Companion</span
            >
          </h1>
          <p class="mt-6 text-lg text-slate-300 max-w-2xl mx-auto">
            Analyze symptoms, get personalized meal plans, visualize medical
            concepts, and ask your AI HealthBuddy anything.
          </p>
          <div class="mt-8">
            <a
              href="#symptom-analyzer"
              class="bg-blue-600 text-white font-semibold px-8 py-3 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 inline-block"
            >
              Get Started
            </a>
          </div>
        </div>
      </section>

      <!-- Symptom Analyzer Section -->
      <section
        id="symptom-analyzer"
        class="py-20 bg-slate-950 dark:bg-slate-950 theme-transition"
      >
        <div class="container mx-auto px-6">
          <div class="animate-content fade-in-up text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-white">
              âœ¨ Symptom Analyzer
            </h2>
            <p class="mt-4 text-slate-400 max-w-xl mx-auto">
              Describe your symptoms to get AI-powered insights. This is not a
              medical diagnosis.
            </p>
          </div>

          <div
            class="animate-content fade-in-up max-w-3xl mx-auto bg-slate-800/50 dark:bg-slate-800/50 rounded-2xl shadow-2xl p-4 md:p-6 theme-transition backdrop-blur-sm"
          >
            <textarea
              id="symptom-input"
              rows="4"
              placeholder="e.g., I have a persistent cough, a slight fever, and body aches..."
              class="w-full bg-slate-700 dark:bg-slate-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 theme-transition mb-4"
            ></textarea>
            <button
              id="analyze-symptoms-btn"
              class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-blue-700 transition w-full flex items-center justify-center gap-2"
            >
              Analyze Symptoms
            </button>
            <div id="symptom-results" class="mt-6"></div>
          </div>
        </div>
      </section>

      <!-- Ask HealthBuddy Section -->
      <section id="healthbuddy" class="py-20">
        <div class="container mx-auto px-6">
          <div class="animate-content fade-in-up text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-white">
              Ask HealthBuddy
            </h2>
            <p class="mt-4 text-slate-400 max-w-xl mx-auto">
              Your 24/7 AI assistant for general health-related questions.
            </p>
          </div>

          <div
            class="animate-content fade-in-up max-w-3xl mx-auto bg-slate-800 dark:bg-slate-800 rounded-2xl shadow-2xl p-4 md:p-6 theme-transition"
          >
            <div
              id="chat-window"
              class="h-96 overflow-y-auto pr-2 flex flex-col gap-4 mb-4"
            >
              <div class="flex items-start gap-3">
                <div
                  class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="white"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"
                    ></path>
                    <path d="M3.22 12H9.5l.7-1 2.1 4.2 3-6 1 2h3.22"></path>
                  </svg>
                </div>
                <div class="chat-bubble-model p-4 max-w-md">
                  Hello! I'm Doctorian AI. How can I help you today? Remember to
                  consult a doctor for medical advice.
                </div>
              </div>
            </div>
            <form
              id="chat-form"
              class="flex items-center gap-3 border-t border-slate-700 dark:border-slate-700 pt-4"
            >
              <input
                id="chat-input"
                type="text"
                placeholder="Ask about symptoms, nutrition, fitness..."
                class="w-full bg-slate-700 dark:bg-slate-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 theme-transition"
              />
              <button
                type="submit"
                class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition flex-shrink-0"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="22" y1="2" x2="11" y2="13"></line>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
              </button>
            </form>
          </div>
        </div>
      </section>

      <!-- Nutrition Planner Section -->
      <section
        id="nutrition-planner"
        class="py-20 bg-slate-950 dark:bg-slate-950 theme-transition"
      >
        <div class="container mx-auto px-6">
          <div class="animate-content fade-in-up text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-white">
              âœ¨ Personalized Nutrition Planner
            </h2>
            <p class="mt-4 text-slate-400 max-w-xl mx-auto">
              Get a custom 3-day meal plan based on your goals and preferences.
            </p>
          </div>
          <div
            class="animate-content fade-in-up max-w-3xl mx-auto bg-slate-800/50 dark:bg-slate-800/50 rounded-2xl shadow-2xl p-4 md:p-6 theme-transition backdrop-blur-sm"
          >
            <form
              id="meal-plan-form"
              class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"
            >
              <div>
                <label
                  for="diet-goal"
                  class="block text-sm font-medium text-slate-300 mb-1"
                  >Primary Goal</label
                >
                <select
                  id="diet-goal"
                  class="w-full bg-slate-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                >
                  <option>Weight Loss</option>
                  <option>Muscle Gain</option>
                  <option>Maintain Weight</option>
                  <option>Heart Health</option>
                </select>
              </div>
              <div>
                <label
                  for="diet-pref"
                  class="block text-sm font-medium text-slate-300 mb-1"
                  >Dietary Preference</label
                >
                <select
                  id="diet-pref"
                  class="w-full bg-slate-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                >
                  <option>None</option>
                  <option>Vegetarian</option>
                  <option>Vegan</option>
                  <option>Gluten-Free</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label
                  for="allergies"
                  class="block text-sm font-medium text-slate-300 mb-1"
                  >Allergies (comma separated)</label
                >
                <input
                  type="text"
                  id="allergies"
                  placeholder="e.g., Peanuts, Shellfish"
                  class="w-full bg-slate-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-500"
                />
              </div>
            </form>
            <button
              id="generate-meal-plan-btn"
              class="bg-cyan-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-cyan-700 transition w-full flex items-center justify-center gap-2"
            >
              Generate Meal Plan
            </button>
            <div id="meal-plan-results" class="mt-6"></div>
          </div>
        </div>
      </section>

      <!-- AI Image Visualizer Section -->
      <section id="visualizer" class="py-20">
        <div class="container mx-auto px-6">
          <div class="animate-content fade-in-up text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-white">
              AI Health Visualizer
            </h2>
            <p class="mt-4 text-slate-400 max-w-xl mx-auto">
              Generate stunning visuals of medical and health concepts with AI.
            </p>
          </div>

          <div
            class="animate-content fade-in-up max-w-3xl mx-auto bg-slate-800/50 dark:bg-slate-800/50 rounded-2xl shadow-2xl p-4 md:p-6 theme-transition backdrop-blur-sm"
          >
            <div class="flex flex-col md:flex-row items-center gap-4 mb-4">
              <input
                id="image-prompt"
                type="text"
                value="A futuristic abstract image of a healthy human heart, digital art"
                class="w-full bg-slate-700 dark:bg-slate-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 theme-transition"
              />
              <button
                id="generate-image-btn"
                class="bg-cyan-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-cyan-700 transition w-full md:w-auto flex-shrink-0 flex items-center justify-center gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"
                  ></path>
                </svg>
                Generate
              </button>
            </div>
            <div
              id="image-container"
              class="aspect-video bg-slate-700 dark:bg-slate-700 rounded-lg flex items-center justify-center theme-transition"
            >
              <div id="image-placeholder" class="text-center text-slate-400">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="mx-auto mb-2"
                >
                  <rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect>
                  <circle cx="9" cy="9" r="2"></circle>
                  <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path>
                </svg>
                <p>Generated image will appear here</p>
              </div>
              <img
                id="generated-image"
                src=""
                alt="AI generated image"
                class="hidden w-full h-full object-cover rounded-lg"
              />
            </div>
          </div>
        </div>
      </section>

      <!-- Footer -->
      <footer class="border-t border-slate-800 dark:border-slate-800 py-8">
        <div class="container mx-auto px-6 text-center text-slate-400">
          <p>&copy; 2025 Doctorian Medical AI. All rights reserved.</p>
          <p class="text-sm mt-2">
            Disclaimer: This tool is for informational purposes only and is not
            a substitute for professional medical advice.
          </p>
        </div>
      </footer>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- Common Functions ---
        const showLoading = (button, originalText) => {
          button.disabled = true;
          button.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Processing...
                `;
        };

        const hideLoading = (button, originalHTML) => {
          button.disabled = false;
          button.innerHTML = originalHTML;
        };

        const renderError = (container, message) => {
          container.innerHTML = `<div class="p-4 rounded-lg bg-red-900/50 text-red-300 border border-red-700">${message}</div>`;
        };

        // AI SDK Helper Functions
        async function generateText(userMessage, sceneName, variables = {}) {
          const startTime = Date.now();
          console.log('ðŸš€ Starting text generation:', { userMessage: userMessage.substring(0, 100) + '...', sceneName, variables });

          if (!window.ywConfig?.ai_config?.[sceneName]) {
            console.error('âŒ API Error - Configuration not found:', sceneName);
            throw new Error(`API Error - Configuration '${sceneName}' not found`);
          }

          const config = window.ywConfig.ai_config[sceneName];
          const systemPrompt = config.system_prompt || '';

          console.log('ðŸ¤– AI API Request:', {
            model: config.model,openai,vercel_ai,
            scene: sceneName,
            input: userMessage.substring(0, 100) + '...',
            systemPrompt: systemPrompt.substring(0, 100) + '...'
          });

          const openai = window.aiSdk.openai.createOpenAI({
            baseURL: 'https://api.vercel.com/public/v1/ai',
            apiKey: 'vck_02KdeRJkckpbozF84mODVVxbPSL2UQeZMgqvMs0PmeQjZru8tV23MvW1'
          });

          try {
            const { text } = await window.aiSdk.ai.generateText({
              model: openai(config.model),
              messages: [
                ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
                { role: 'user', content: userMessage }
              ],
              temperature: config.temperature || 0.7,
              maxTokens: config.maxTokens || 4000
            });

            console.log('âœ… AI API Response:', {
              model: config.model,vercel_ai,openai,
              scene: sceneName,
              outputLength: text.length,
              responsePreview: text.substring(0, 150) + '...',
              processingTime: `${Date.now() - startTime}ms`
            });

            return text;
          } catch (error) {
            console.error('âŒ API Error - Text generation failed:', {
              model: config.model,
              scene: sceneName,
              error: error.message,
              processingTime: `${Date.now() - startTime}ms`
            });
            throw new Error(`API Error - Text generation failed: ${error.message}`);
          }
        }

        async function generateStructuredOutput(prompt, schema, sceneName) {
          const startTime = Date.now();
          console.log('ðŸ”§ Starting structured output generation:', { prompt: prompt.substring(0, 100) + '...', sceneName });

          const config = window.ywConfig.ai_config[sceneName];
          if (!config) {
            console.error('âŒ API Error - Structured config not found:', sceneName);
            throw new Error(`API Error - Structured config '${sceneName}' not found`);
          }

          console.log('ðŸ¤– AI API Request (Structured):', {
            model: config.model,
            scene: sceneName,
            prompt: prompt.substring(0, 150) + '...'
          });

          const openai = window.aiSdk.openai.createOpenAI({
            baseURL: 'https://api.vercel.com/public/v1/ai',
            apiKey: 'vck_02KdeRJkckpbozF84mODVVxbPSL2UQeZMgqvMs0PmeQjZru8tV23MvW1'
          });

          try {
            const result = await window.aiSdk.ai.generateObject({
              model: openai(config.model),
              prompt: prompt,
              schema: schema,
              temperature: config.temperature || 0.7
            });

            console.log('âœ… AI API Response (Structured):', {
              model: config.model,
              scene: sceneName,
              outputKeys: Object.keys(result.object),
              processingTime: `${Date.now() - startTime}ms`
            });

            return result.object;
          } catch (error) {
            console.error('âŒ API Error - Structured output failed:', {
              model: config.model,
              scene: sceneName,
              error: error.message,
              processingTime: `${Date.now() - startTime}ms`
            });
            throw new Error(`API Error - Structured output failed: ${error.message}`);
          }
        }

        async function generateImage(description, sceneName) {
          const startTime = Date.now();
          console.log('ðŸŽ¨ Starting image generation:', { description: description.substring(0, 100) + '...', sceneName });

          const config = window.ywConfig.ai_config[sceneName];
          if (!config) {
            console.error('âŒ API Error - Image config not found:', sceneName);
            throw new Error(`API Error - Image config '${sceneName}' not found`);
          }

          const prompt = config.prompt_template ? description : description;

          console.log('ðŸ¤– AI API Request (Image):', {
            model: config.model,
            scene: sceneName,
            prompt: prompt.substring(0, 150) + '...'
          });

          try {
            const response = await fetch('https://api.vercel.com/public/v1/ai/images/generations', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer vck_02KdeRJkckpbozF84mODVVxbPSL2UQeZMgqvMs0PmeQjZru8tV23MvW1'
              },
              body: JSON.stringify({
                model: config.model,
                prompt: prompt,
                n: config.n || 1,
                size: config.size || '1024x1024',
                response_format: config.response_format || 'b64_json'
              })
            });

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              console.error('âŒ API Error - Image generation request failed:', response.status, response.statusText, errorData);
              throw new Error(`API Error - Image generation request failed: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();

            console.log('âœ… AI API Response (Image):', {
              model: config.model,
              scene: sceneName,
              responseFormat: config.response_format,
              imagesGenerated: data.data ? data.data.length : 0,
              processingTime: `${Date.now() - startTime}ms`
            });

            if (data && data.data && data.data.length > 0) {
              return data.data[0];
            } else {
              console.error('âŒ API Error - Invalid response format:', data);
              throw new Error('API Error - Invalid response format');
            }
          } catch (error) {
            console.error('âŒ API Error - Image generation failed:', {
              model: config.model,
              scene: sceneName,
              error: error.message,
              processingTime: `${Date.now() - startTime}ms`
            });
            throw new Error(`API Error - Image generation failed: ${error.message}`);
          }
        }

        // --- Theme Toggler ---
        const themeToggle = document.getElementById("theme-toggle");
        const darkIcon = document.getElementById("theme-icon-dark");
        const htmlEl = document.documentElement;

        const setTheme = (theme) => {
          if (theme === "dark") {
            htmlEl.classList.add("dark");
            htmlEl.classList.remove("light");
            if (darkIcon) darkIcon.classList.remove("hidden");
          } else {
            htmlEl.classList.remove("dark");
            htmlEl.classList.add("light");
            if (darkIcon) darkIcon.classList.remove("hidden");
          }
          localStorage.setItem("theme", theme);
        };

        themeToggle.addEventListener("click", () => {
          const currentTheme = htmlEl.classList.contains("dark")
            ? "dark"
            : "light";
          setTheme(currentTheme === "dark" ? "light" : "dark");
        });

        const savedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)"
        ).matches;
        if (savedTheme) {
          setTheme(savedTheme);
        } else {
          setTheme(prefersDark ? "dark" : "light");
        }

        // --- Scroll Animations ---
        const animatedElements = document.querySelectorAll(".animate-content");
        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("is-visible");
              }
            });
          },
          { threshold: 0.1 }
        );
        animatedElements.forEach((el) => observer.observe(el));

        // --- Symptom Analyzer ---
        const analyzeBtn = document.getElementById("analyze-symptoms-btn");
        const symptomInput = document.getElementById("symptom-input");
        const symptomResultsContainer =
          document.getElementById("symptom-results");
        const originalAnalyzeBtnHTML = analyzeBtn.innerHTML;

        const symptomSchema = window.aiSdk.z.object({
          potential_causes: window.aiSdk.z.array(
            window.aiSdk.z.object({
              condition: window.aiSdk.z.string(),
              description: window.aiSdk.z.string()
            })
          ),
          self_care_tips: window.aiSdk.z.array(window.aiSdk.z.string()),
          when_to_see_doctor: window.aiSdk.z.array(window.aiSdk.z.string())
        });

        analyzeBtn.addEventListener("click", async () => {
          const symptoms = symptomInput.value.trim();
          if (!symptoms) {
            renderError(
              symptomResultsContainer,
              "Please describe your symptoms first."
            );
            return;
          }

          showLoading(analyzeBtn);
          symptomResultsContainer.innerHTML =
            '<div class="p-4 rounded-lg bg-slate-700/50 text-slate-300">Analyzing your symptoms...</div>';

          const userPrompt = `Analyze the following symptoms: "${symptoms}". Provide a list of potential, non-diagnostic causes, general self-care tips, and specific signs that indicate when to see a doctor. Do not provide a diagnosis. This is for informational purposes only.`;

          try {
            const data = await generateStructuredOutput(userPrompt, symptomSchema, 'symptom_analyzer');
            renderSymptomAnalysis(data);
          } catch (error) {
            console.error("Symptom Analyzer Error:", error);
            renderError(
              symptomResultsContainer,
              "Sorry, an error occurred while analyzing symptoms. Please try again."
            );
          } finally {
            hideLoading(analyzeBtn, originalAnalyzeBtnHTML);
          }
        });

        function renderSymptomAnalysis(data) {
          let html = `
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold text-white mb-3">Potential Causes</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${data.potential_causes
                                  .map(
                                    (item) => `
                                    <div class="result-card p-4 rounded-lg border border-slate-700 theme-transition">
                                        <h4 class="font-semibold text-blue-300">${item.condition}</h4>
                                        <p class="text-sm text-slate-400 mt-1">${item.description}</p>
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold text-white mb-3">Self-Care Suggestions</h3>
                            <ul class="list-disc list-inside space-y-2 text-slate-300">
                                ${data.self_care_tips
                                  .map((tip) => `<li>${tip}</li>`)
                                  .join("")}
                            </ul>
                        </div>
                        <div class="p-4 rounded-lg bg-yellow-900/50 text-yellow-300 border border-yellow-700">
                             <h3 class="text-xl font-semibold text-white mb-3">When to See a Doctor</h3>
                             <p class="font-semibold mb-2">Consult a healthcare professional if you experience:</p>
                             <ul class="list-disc list-inside space-y-2">
                                ${data.when_to_see_doctor
                                  .map((item) => `<li>${item}</li>`)
                                  .join("")}
                             </ul>
                        </div>
                        <p class="text-xs text-center text-slate-500 pt-4">DISCLAIMER: This is AI-generated information and not a medical diagnosis. Always consult a qualified healthcare provider for medical advice.</p>
                    </div>
                `;
          symptomResultsContainer.innerHTML = html;
        }

        // --- HealthBuddy Chatbot ---
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const chatWindow = document.getElementById("chat-window");

        let conversationHistory = [];

        chatForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const userMessage = chatInput.value.trim();
          if (!userMessage) return;

          appendMessage(userMessage, "user");
          chatInput.value = "";
          showTypingIndicator();

          // Add to conversation history
          conversationHistory.push({
            role: 'user',
            content: userMessage
          });

          try {
            const config = window.ywConfig.ai_config.health_chatbot;
            const openai = window.aiSdk.openai.createOpenAI({
              baseURL: 'https://api.vercel.com/public/v1/ai',
              apiKey: 'vck_02KdeRJkckpbozF84mODVVxbPSL2UQeZMgqvMs0PmeQjZru8tV23MvW1'
            });

            const { text } = await window.aiSdk.ai.generateText({
              model: openai(config.model),
              messages: [
                { role: 'system', content: config.system_prompt },
                ...conversationHistory
              ],
              temperature: config.temperature || 0.7,
              maxTokens: config.maxTokens || 4000
            });

            conversationHistory.push({
              role: 'assistant',
              content: text
            });

            removeTypingIndicator();
            appendMessage(text, "model");
          } catch (error) {
            console.error("HealthBuddy Error:", error);
            removeTypingIndicator();
            appendMessage("Oops! Something went wrong.", "model");
          }
        });

        function appendMessage(text, role) {
          const messageDiv = document.createElement("div");
          const bubbleDiv = document.createElement("div");
          if (role === "user") {
            messageDiv.className = "flex justify-end";
            bubbleDiv.className = "chat-bubble-user p-4 max-w-md";
          } else {
            messageDiv.className = "flex items-start gap-3";
            const iconContainer = document.createElement("div");
            iconContainer.className =
              "flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center";
            iconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path><path d="M3.22 12H9.5l.7-1 2.1 4.2 3-6 1 2h3.22"></path></svg>`;
            messageDiv.appendChild(iconContainer);
            bubbleDiv.className = "chat-bubble-model p-4 max-w-md";
          }
          bubbleDiv.textContent = text;
          messageDiv.appendChild(bubbleDiv);
          chatWindow.appendChild(messageDiv);
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showTypingIndicator() {
          const indicator = document.createElement("div");
          indicator.id = "typing-indicator";
          indicator.className = "flex items-start gap-3";
          indicator.innerHTML = `<div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">...</div><div class="chat-bubble-model p-4"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
          chatWindow.appendChild(indicator);
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function removeTypingIndicator() {
          const indicator = document.getElementById("typing-indicator");
          if (indicator) indicator.remove();
        }

        // --- Nutrition Planner ---
        const generateMealPlanBtn = document.getElementById(
          "generate-meal-plan-btn"
        );
        const mealPlanResultsContainer =
          document.getElementById("meal-plan-results");
        const originalMealPlanBtnHTML = generateMealPlanBtn.innerHTML;

        generateMealPlanBtn.addEventListener("click", async () => {
          const goal = document.getElementById("diet-goal").value;
          const preference = document.getElementById("diet-pref").value;
          const allergies = document.getElementById("allergies").value;

          showLoading(generateMealPlanBtn);
          mealPlanResultsContainer.innerHTML =
            '<div class="p-4 rounded-lg bg-slate-700/50 text-slate-300">Generating your personalized meal plan...</div>';

          let prompt = `Generate a simple 3-day meal plan for someone whose goal is ${goal}. `;
          if (preference !== "None")
            prompt += `They follow a ${preference} diet. `;
          if (allergies) prompt += `They are allergic to ${allergies}. `;
          prompt += `For each day, provide ideas for breakfast, lunch, and dinner. The output should be a simple to read plan.`;

          try {
            const planText = await generateText(prompt, 'nutrition_planner');
            renderMealPlan(planText);
          } catch (error) {
            console.error("Meal Plan Error:", error);
            renderError(
              mealPlanResultsContainer,
              "Sorry, we couldn't generate your meal plan. Please try again."
            );
          } finally {
            hideLoading(generateMealPlanBtn, originalMealPlanBtnHTML);
          }
        });

        function renderMealPlan(planText) {
          // Simple formatting by splitting into paragraphs and wrapping them.
          const paragraphs = planText
            .split("\n")
            .filter((p) => p.trim() !== "");
          let html =
            '<div class="result-card p-4 rounded-lg border border-slate-700 theme-transition space-y-4 text-slate-300">';
          paragraphs.forEach((p) => {
            if (
              p.includes("Day 1") ||
              p.includes("Day 2") ||
              p.includes("Day 3")
            ) {
              html += `<h4 class="text-lg font-semibold text-cyan-300 pt-2">${p.replace(
                /\*/g,
                ""
              )}</h4>`;
            } else if (
              p.includes("Breakfast:") ||
              p.includes("Lunch:") ||
              p.includes("Dinner:")
            ) {
              html += `<p><strong class="font-medium text-slate-100">${
                p.split(":")[0]
              }:</strong> ${p
                .split(":")
                .slice(1)
                .join(":")
                .replace(/\*/g, "")}</p>`;
            } else {
              html += `<p class="text-sm">${p.replace(/\*/g, "")}</p>`;
            }
          });
          html +=
            '<p class="text-xs text-center text-slate-500 pt-4">DISCLAIMER: Consult a nutritionist or doctor before starting any new diet.</p></div>';
          mealPlanResultsContainer.innerHTML = html;
        }

        // --- Image Generator ---
        const generateImageBtn = document.getElementById("generate-image-btn");
        const imagePromptInput = document.getElementById("image-prompt");
        const imageContainer = document.getElementById("image-container");
        const imagePlaceholder = document.getElementById("image-placeholder");
        const generatedImage = document.getElementById("generated-image");
        const originalImageBtnHTML = generateImageBtn.innerHTML;

        generateImageBtn.addEventListener("click", async () => {
          const prompt = imagePromptInput.value.trim();
          if (!prompt) {
            alert("Please enter a prompt to generate an image.");
            return;
          }

          showLoading(generateImageBtn);
          generatedImage.classList.add("hidden");
          imagePlaceholder.classList.add("hidden");
          imageContainer.classList.add("shimmer");

          try {
            const imageData = await generateImage(prompt, 'health_visualizer');
            
            if (imageData.b64_json) {
              generatedImage.src = `data:image/png;base64,${imageData.b64_json}`;
              generatedImage.classList.remove("hidden");
            } else if (imageData.url) {
              generatedImage.src = imageData.url;
              generatedImage.classList.remove("hidden");
            } else {
              throw new Error("No image data found in response.");
            }
          } catch (error) {
            console.error("Error generating image:", error);
            imagePlaceholder.classList.remove("hidden");
            imagePlaceholder.innerHTML =
              '<p class="text-red-400">Failed to generate image. Please try again.</p>';
          } finally {
            imageContainer.classList.remove("shimmer");
            hideLoading(generateImageBtn, originalImageBtnHTML);
          }
        });
      });
    </script>
  </body>
</html>
